---
import Layout from '@/layouts/Layout.astro';
import Button from '@/components/Button.astro';
import { getLangFromUrl, useTranslations } from '@/i18n/utils';
import { defaultLang } from '@/i18n/ui';
import { getCollection } from 'astro:content';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Get all projects for the current language
const allProjects = await getCollection('projects', ({ id }) => {
    return id.startsWith(`${lang}/`);
});

// Extract technologies from projects
const extractTechnologiesFromContent = (content: string): string[] => {
    const techMatches = content.match(/\*\*([^*]+)\*\*/g) || [];
    const technologies = techMatches
        .map(match => match.replace(/\*\*/g, '').trim())
        .filter(tech => {
            // Filter out non-technical terms
            const techKeywords = ['JavaScript', 'TypeScript', 'React', 'Vue', 'Node.js', 'PHP', 'Python', 'CSS', 'HTML', 'Astro', 'Next.js', 'Nuxt.js', 'Express', 'PostgreSQL', 'MySQL', 'MongoDB', 'GraphQL', 'REST', 'API', 'Docker', 'AWS', 'Vercel', 'Git', 'GitHub', 'Tailwind', 'SASS', 'SCSS', 'NPM', 'Webpack', 'Rollup', 'Redis', 'Strapi', 'Processwire', 'CMS'];
            return techKeywords.some(keyword => tech.toLowerCase().includes(keyword.toLowerCase()));
        });
    return [...new Set(technologies)];
};

// Get technologies from all projects (both from tags and content)
const projectTechnologies = allProjects.flatMap(project => {
    const { body, data } = project;
    const contentTechs = extractTechnologiesFromContent(body);
    const tagTechs = data.tags || [];
    return [...contentTechs, ...tagTechs];
});

const uniqueTechnologies = [...new Set(projectTechnologies)];

// Dynamic ATS-friendly keywords (invisible but searchable) from projects + static keywords
const staticAtsKeywords = [
    'React Developer', 'TypeScript Developer', 'Frontend Developer', 'Backend Developer',
    'Full Stack Developer', 'JavaScript Developer', 'Node.js Developer', 'Web Developer',
    'UI/UX Designer', 'Responsive Design', 'Mobile First', 'Performance Optimization',
    'SEO Specialist', 'Accessibility Expert', 'WCAG Compliance', 'Cross Browser Compatibility',
    'Agile Development', 'Scrum Master', 'Code Review', 'Version Control', 'Git Workflow',
    'API Development', 'REST API', 'GraphQL', 'Database Design', 'PostgreSQL',
    'AWS Cloud', 'Docker Containers', 'CI/CD Pipeline', 'DevOps', 'Vercel Deployment',
    'Astro Framework', 'Next.js', 'Tailwind CSS', 'CSS3', 'HTML5', 'ES6+',
    'React Hooks', 'State Management', 'Component Architecture', 'Testing',
    'Problem Solving', 'Team Collaboration', 'Project Management', 'Client Communication',
    'Spanish Native', 'English Advanced', 'Norwegian Intermediate', 'Multilingual',
    'Santiago Chile', 'Remote Work', 'Freelance', 'Contract Work', 'Available'
];

// Combine static keywords with project technologies
const atsKeywords = [...staticAtsKeywords, ...uniqueTechnologies].filter((keyword, index, arr) => 
    arr.findIndex(k => k.toLowerCase() === keyword.toLowerCase()) === index
);
---

<Layout title={`${t('cv.title')} - ${t('site.title')}`} description={t('about.tldr.description')} lang={lang}>
    
    <!-- ATS Keywords (invisible but searchable) -->
    <div class="ats-keywords" aria-hidden="true" style="position: absolute; left: -9999px; width: 1px; height: 1px; overflow: hidden; opacity: 0; font-size: 1px; line-height: 1; color: transparent;">
        {atsKeywords.join(' ')}
        Full Stack Web Developer React TypeScript Node.js Astro Tailwind CSS PostgreSQL GraphQL
        Frontend Backend JavaScript ES6 HTML5 CSS3 Responsive Design Mobile First
        Performance Optimization SEO Accessibility WCAG Git GitHub Docker AWS Vercel
        Agile Scrum Code Review API Development REST GraphQL Database Design
        UI UX Design Problem Solving Team Collaboration Project Management
        Spanish English Norwegian Multilingual Santiago Chile Remote Freelance
    </div>

    <!-- Floating Print Button (bottom right) -->
    <div class="no-print fixed bottom-8 right-8 z-50">
        <Button filled elevated onclick="window.print()" class="print-button">
            {t('ui.print')}
        </Button>
    </div>

    <style>
        @page {
            size: A4;
            margin: 15mm;
        }
        
        /* Use main site theme system - colors are defined in themes.css */
        /* No need to redefine --color-main and --color-secondary */
        
        /* Theme-aware styling with brutalist typography */
        body {
            color: var(--color-main);
            background: var(--color-secondary);
            font-family: 'JetBrains Mono', 'IBM Plex Mono', monospace;
            font-weight: 500;
            line-height: 1.4;
            letter-spacing: 0.025em;
        }
        
        .a4-page {
            background: var(--color-secondary);
            color: var(--color-main);
        }
        
        .cv-border {
            border-color: var(--color-main);
        }
        
        .cv-text-primary {
            color: var(--color-main);
        }
        
        .cv-text-secondary {
            color: var(--color-main);
            opacity: 0.65;
        }
        
        .cv-bg-tag {
            background: var(--color-main);
            color: var(--color-secondary);
        }
        
        .cv-bg-accent {
            background: var(--color-secondary);
            color: var(--color-main);
            border: 1px solid var(--color-main);
        }
        
        /* ATS Keywords - invisible but searchable */
        .ats-keywords {
            position: absolute;
            left: -9999px;
            width: 1px;
            height: 1px;
            overflow: hidden;
            opacity: 0;
            font-size: 1px;
            line-height: 1;
            color: transparent;
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
            
            .print-text {
                display: inline !important;
            }
            
            .print-hide {
                display: none !important;
            }
            
            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                font-size: 11px !important;
                background: white !important;
                color: black !important;
            }
            
            .a4-page {
                background: white !important;
                color: black !important;
                box-shadow: none !important;
            }
            
            .cv-border {
                border-color: black !important;
            }
            
            .cv-text-primary {
                color: black !important;
            }
            
            .cv-text-secondary {
                color: #333 !important;
            }
            
            .cv-bg-tag {
                background: black !important;
                color: white !important;
            }
            
            .print-minimal {
                background: white !important;
                border: 1px solid #333 !important;
                padding: 4px 8px !important;
                box-shadow: none !important;
            }
            
            .print-no-bg {
                background: white !important;
                border: 2px solid #333 !important;
                padding: 8px !important;
                box-shadow: none !important;
            }
            
            .print-light-border {
                border-bottom: 2px solid #333 !important;
                padding-bottom: 4px !important;
                margin-bottom: 8px !important;
            }
            
            /* Enhanced print optimizations */
            @media print {
                body {
                    font-size: 10px !important;
                    line-height: 1.3 !important;
                }
                
                .a4-page {
                    padding: 15mm !important;
                    box-shadow: none !important;
                    border: none !important;
                }
                
                .section-title {
                    background: black !important;
                    color: white !important;
                    border: 1px solid black !important;
                    padding: 3px 6px !important;
                    margin-bottom: 6px !important;
                    font-size: 9px !important;
                }
                
                .subsection-title {
                    font-size: 8px !important;
                    margin-bottom: 3px !important;
                    border-bottom: 1px solid black !important;
                }
                
                .cv-bg-tag {
                    background: black !important;
                    color: white !important;
                    border: 1px solid black !important;
                    box-shadow: none !important;
                    padding: 1px 3px !important;
                    font-size: 7px !important;
                }
                
                .cv-two-column {
                    gap: 15mm !important;
                }
                
                .section-spacing {
                    margin-bottom: 8px !important;
                }
                
                .tight-spacing {
                    margin-bottom: 3px !important;
                }
                
                .compact-spacing {
                    margin-bottom: 2px !important;
                }
            }
        }
        
        @media screen {
            .print-text {
                display: none;
            }
            
            body {
                background: var(--color-secondary);
                padding: 3rem 1rem;
                min-height: 100vh;
            }
        }
        
        /* A4 dimensions optimized for content */
        .a4-page {
            width: 210mm;
            min-height: 297mm;
            max-width: 100%;
            margin: 0 auto;
            box-shadow: 8px 8px 0 var(--color-main);
            border: 4px solid var(--color-main);
            overflow: hidden;
            background: var(--color-secondary);
            display: flex;
            flex-direction: column;
        }
        
        @media (max-width: 768px) {
            .a4-page {
                width: 100%;
                margin: 0;
                box-shadow: none;
                border: 2px solid var(--color-main);
            }
        }
        
        /* Social icons */
        .social-icon {
            width: 16px;
            height: 16px;
            display: inline-block;
            vertical-align: middle;
            margin-right: 6px;
        }
        
        /* Better spacing for readability */
        .section-spacing {
            margin-bottom: 2rem;
        }
        
        .content-spacing {
            margin-bottom: 1.5rem;
        }
        
        .tight-spacing {
            margin-bottom: 1rem;
        }
        
        .compact-spacing {
            margin-bottom: 0.5rem;
        }
        
        .section-title {
            font-size: 1.1rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            border: 2px solid var(--color-main);
            background: var(--color-main);
            color: var(--color-secondary);
            padding: 0.75rem 1rem;
            margin-bottom: 1.25rem;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .subsection-title {
            font-size: 1rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
            font-family: 'JetBrains Mono', monospace;
            border-bottom: 2px solid var(--color-main);
            padding-bottom: 0.5rem;
        }
        
        /* Optimized grid system */
        .cv-grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .cv-grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }
        
        .cv-grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
        }
        
        .cv-two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 3rem;
            height: 100%;
        }
        
        @media (max-width: 768px) {
            .cv-grid-2, .cv-grid-3, .cv-grid-4 {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .cv-two-column {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .a4-page {
                border: 2px solid var(--color-main);
                box-shadow: none;
            }
        }
        
        /* Brutalist buttons */
        .cv-button {
            background: var(--color-secondary);
            color: var(--color-main);
            border: 2px solid var(--color-main);
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            transition: none;
            box-shadow: 4px 4px 0 var(--color-main);
        }
        
        .cv-button:hover {
            background: var(--color-main);
            color: var(--color-secondary);
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0 var(--color-main);
        }
        
        .cv-button-primary {
            background: var(--color-main);
            color: var(--color-secondary);
        }
        
        .cv-button-primary:hover {
            background: var(--color-secondary);
            color: var(--color-main);
        }
    </style>

    <!-- CV Content with A4 layout -->
    <div class="a4-page p-16">
        <!-- Header with Name and Image -->
        <header class="section-spacing flex justify-between items-start">
            <div class="flex-1 max-w-2xl">
                <h1 class="text-4xl font-bold cv-text-primary tight-spacing tracking-tight font-mono">{t('site.title')}</h1>
                <h2 class="text-xl cv-text-secondary compact-spacing font-medium font-mono">{t('site.subtitle')}</h2>
                
                <!-- Contact Info -->
                <div class="cv-grid-2 gap-4 text-sm content-spacing font-mono">
                    <div class="flex items-center gap-3">
                        <span class="cv-text-primary font-semibold">✉</span>
                        <span class="cv-text-secondary">{t('cv.email')}</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="cv-text-primary font-semibold">📍</span>
                        <span class="cv-text-secondary">{t('cv.location')}</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="cv-text-primary font-semibold">🌐</span>
                        <span class="cv-text-secondary">{t('cv.website')}</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="cv-text-primary font-semibold">📱</span>
                        <span class="cv-text-secondary">{t('cv.phone')}</span>
                    </div>
                </div>
                
            </div>
            
            <!-- Profile Image -->
            <div class="ml-8 flex-shrink-0">
                <div class="w-28 h-28 overflow-hidden border-4 cv-border" style="box-shadow: 4px 4px 0 var(--color-main)">
                    <img src="/images/profile.jpg" alt="Allison Peña Profile Photo" class="w-full h-full object-cover" style="image-rendering: pixelated;" />
                </div>
            </div>
        </header>

        <!-- Professional Summary -->
        <section class="content-spacing">
            <h3 class="section-title">Professional Summary</h3>
            <div class="border-2 cv-border p-4" style="box-shadow: 4px 4px 0 var(--color-main);">
                <p class="text-sm cv-text-secondary font-mono leading-relaxed">
                    {t('about.tldr.description')}
                </p>
            </div>
        </section>

        <!-- Two Column Layout for Better Space Usage -->
        <div class="cv-two-column flex-1">
            <!-- Left Column -->
            <div class="space-y-4">
                <!-- Core Skills -->
                <section>
                    <h3 class="section-title">{t('cv.skills.title')}</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <h4 class="subsection-title cv-text-primary">{t('cv.skills.frontend')}</h4>
                            <div class="text-sm cv-text-secondary font-mono leading-relaxed">
                                React.js • TypeScript • Astro • Tailwind CSS • Next.js • HTML5 • CSS3
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="subsection-title cv-text-primary">{t('cv.skills.backend')}</h4>
                            <div class="text-sm cv-text-secondary font-mono leading-relaxed">
                                Node.js • PostgreSQL • GraphQL • REST APIs • Prisma • Database Design
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="subsection-title cv-text-primary">{t('cv.skills.tools')}</h4>
                            <div class="text-sm cv-text-secondary font-mono leading-relaxed">
                                Git • Docker • AWS • Vercel • Figma • CI/CD • Performance Optimization
                            </div>
                        </div>
                    </div>
                </section>

                        <!-- Technology Stack -->
                <section>
                    <h3 class="section-title">Stack Tecnológico</h3>
                    
                    <div class="flex flex-wrap gap-2">
                        {uniqueTechnologies.length > 0 ? uniqueTechnologies.slice(0, 10).map((tech) => (
                            <span class="cv-bg-tag px-3 py-1 text-sm font-bold border-2" style="border-color: var(--color-main); box-shadow: 2px 2px 0 var(--color-main); font-family: 'JetBrains Mono', monospace;">{tech}</span>
                        )) : (
                            <>
                                <span class="cv-bg-tag px-3 py-1 text-sm font-bold border-2" style="border-color: var(--color-main); box-shadow: 2px 2px 0 var(--color-main); font-family: 'JetBrains Mono', monospace;">React</span>
                                <span class="cv-bg-tag px-3 py-1 text-sm font-bold border-2" style="border-color: var(--color-main); box-shadow: 2px 2px 0 var(--color-main); font-family: 'JetBrains Mono', monospace;">TypeScript</span>
                                <span class="cv-bg-tag px-3 py-1 text-sm font-bold border-2" style="border-color: var(--color-main); box-shadow: 2px 2px 0 var(--color-main); font-family: 'JetBrains Mono', monospace;">Node.js</span>
                                <span class="cv-bg-tag px-3 py-1 text-sm font-bold border-2" style="border-color: var(--color-main); box-shadow: 2px 2px 0 var(--color-main); font-family: 'JetBrains Mono', monospace;">Astro</span>
                                <span class="cv-bg-tag px-3 py-1 text-sm font-bold border-2" style="border-color: var(--color-main); box-shadow: 2px 2px 0 var(--color-main); font-family: 'JetBrains Mono', monospace;">Tailwind</span>
                                <span class="cv-bg-tag px-3 py-1 text-sm font-bold border-2" style="border-color: var(--color-main); box-shadow: 2px 2px 0 var(--color-main); font-family: 'JetBrains Mono', monospace;">PostgreSQL</span>
                                <span class="cv-bg-tag px-3 py-1 text-sm font-bold border-2" style="border-color: var(--color-main); box-shadow: 2px 2px 0 var(--color-main); font-family: 'JetBrains Mono', monospace;">GraphQL</span>
                                <span class="cv-bg-tag px-3 py-1 text-sm font-bold border-2" style="border-color: var(--color-main); box-shadow: 2px 2px 0 var(--color-main); font-family: 'JetBrains Mono', monospace;">Docker</span>
                                <span class="cv-bg-tag px-3 py-1 text-sm font-bold border-2" style="border-color: var(--color-main); box-shadow: 2px 2px 0 var(--color-main); font-family: 'JetBrains Mono', monospace;">AWS</span>
                                <span class="cv-bg-tag px-3 py-1 text-sm font-bold border-2" style="border-color: var(--color-main); box-shadow: 2px 2px 0 var(--color-main); font-family: 'JetBrains Mono', monospace;">Git</span>
                            </>
                        )}
                    </div>
                </section>

                <!-- Languages -->
                <section>
                    <h3 class="section-title">{t('cv.languages.title')}</h3>
                    <div class="text-sm cv-text-secondary font-mono space-y-2">
                        <div class="border-l-4 cv-border pl-3" style="border-left-color: var(--color-main);">
                            <span class="font-semibold cv-text-primary">{t('cv.languages.spanish')}</span>
                        </div>
                        <div class="border-l-4 cv-border pl-3" style="border-left-color: var(--color-main);">
                            <span class="font-semibold cv-text-primary">{t('cv.languages.english')}</span>
                        </div>
                        <div class="border-l-4 cv-border pl-3" style="border-left-color: var(--color-main);">
                            <span class="font-semibold cv-text-primary">{t('cv.languages.norwegian')}</span>
                        </div>
                    </div>
                </section>
            </div>
            
            <!-- Right Column -->
            <div class="space-y-4">
                <!-- Professional Experience -->
                <section>
                    <h3 class="section-title">{t('cv.experience.title')}</h3>
                    
                    <div class="space-y-4">
                        <div class="border-l-2 cv-border pl-3" style="border-left-color: var(--color-main);">
                            <div class="flex justify-between items-start mb-1">
                                <h4 class="font-bold cv-text-primary text-sm font-mono">Full-Stack Developer</h4>
                                <span class="text-xs cv-text-secondary font-mono">2021 - Present</span>
                            </div>
                            <p class="text-xs cv-text-secondary mb-2 font-mono">Freelance & Contract Work</p>
                            <ul class="text-xs cv-text-secondary space-y-1 leading-tight font-mono">
                                <li>• Desarrollo de aplicaciones web accesibles React/TypeScript/Node.js</li>
                                <li>• Performance optimization, SEO y accessibility (WCAG)</li>
                                <li>• Colaboración en equipos Agile, arquitectura frontend</li>
                                <li>• Diseño APIs RESTful y GraphQL</li>
                            </ul>
                        </div>
                        
                        <div class="border-l-2 cv-border pl-3" style="border-left-color: var(--color-main);">
                            <div class="flex justify-between items-start mb-1">
                                <h4 class="font-bold cv-text-primary text-sm font-mono">Web Developer</h4>
                                <span class="text-xs cv-text-secondary font-mono">2020 - 2021</span>
                            </div>
                            <p class="text-xs cv-text-secondary mb-2 font-mono">Junior Position</p>
                            <ul class="text-xs cv-text-secondary space-y-1 leading-tight font-mono">
                                <li>• Mantenimiento sitios web JavaScript, HTML5, CSS3</li>
                                <li>• Mejores prácticas desarrollo, accessibility, responsive</li>
                                <li>• Code reviews, pair programming, testing</li>
                                <li>• Componentes reutilizables, documentación técnica</li>
                            </ul>
                        </div>
                    </div>
                </section>

                <!-- Featured Projects -->
                <section>
                    <h3 class="section-title">Proyectos Destacados</h3>
                    
                    <div class="space-y-2">
                        {allProjects.length > 0 ? allProjects.filter(project => project.data.isFeatured).slice(0, 3).map((project) => {
                            const contentTechs = extractTechnologiesFromContent(project.body);
                            const projectTags = project.data.tags || [];
                            const allProjectTechs = [...new Set([...contentTechs, ...projectTags])].slice(0, 4);
                            
                            return (
                                <div class="border-2 cv-border p-3 print-no-bg" style="box-shadow: 2px 2px 0 var(--color-main);">
                                    <div class="flex justify-between items-start mb-1">
                                        <h4 class="font-bold cv-text-primary text-sm font-mono">{project.data.title}</h4>
                                        <span class="text-xs cv-text-secondary font-mono">{new Date(project.data.publishDate).getFullYear()}</span>
                                    </div>
                                    <p class="text-xs cv-text-secondary mb-2 leading-tight font-mono">{project.data.description}</p>
                                    
                                    {allProjectTechs.length > 0 && (
                                        <div class="flex flex-wrap gap-1">
                                            {allProjectTechs.map((tech) => (
                                                <span class="cv-bg-tag px-1 py-0.5 text-xs font-bold border" style="border-color: var(--color-main); font-family: 'JetBrains Mono', monospace;">{tech}</span>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            );
                        }) : (
                            <div class="border-2 cv-border p-3 print-no-bg" style="box-shadow: 2px 2px 0 var(--color-main);">
                                <h4 class="font-bold cv-text-primary mb-1 text-sm font-mono">Portfolio Personal</h4>
                                <p class="text-xs cv-text-secondary mb-2 leading-tight font-mono">Sitio web con diseño brutalist, multilenguaje (ES/EN/NO), optimizaciones performance</p>
                                <div class="flex flex-wrap gap-1">
                                    <span class="cv-bg-tag px-1 py-0.5 text-xs font-bold border" style="border-color: var(--color-main); font-family: 'JetBrains Mono', monospace;">Astro</span>
                                    <span class="cv-bg-tag px-1 py-0.5 text-xs font-bold border" style="border-color: var(--color-main); font-family: 'JetBrains Mono', monospace;">React</span>
                                    <span class="cv-bg-tag px-1 py-0.5 text-xs font-bold border" style="border-color: var(--color-main); font-family: 'JetBrains Mono', monospace;">TypeScript</span>
                                </div>
                            </div>
                        )}
                    </div>
                </section>


                <!-- Education -->
                <section>
                    <h3 class="section-title">{t('cv.education.title')}</h3>
                    
                    <div class="border-l-2 cv-border pl-3" style="border-left-color: var(--color-main);">
                        <div class="flex justify-between items-start mb-1">
                            <h4 class="font-bold cv-text-primary text-sm font-mono">Autodidacta / Self-Taught</h4>
                            <span class="text-xs cv-text-secondary font-mono">2020 - Present</span>
                        </div>
                        <p class="text-xs cv-text-secondary leading-tight font-mono">Continuous learning: online resources, documentation, hands-on projects, professional development courses</p>
                    </div>
                </section>
            </div>
        </div>
    </div>
</body>
</html>