---
import ProjectCard from '../ProjectCard.astro';
import ProjectCarousel from '../ProjectCarousel.astro';
import ProjectsTable from '../ProjectsTable.astro';
import { getFeaturedProjectsByLanguage, getProjectsByLanguage, getSlugFromId } from '@/utils/content-utils';
import { getTranslations } from '@/i18n/utils';
import { defaultLang, type Language } from '@/i18n/ui';
import { getLocalizedUrl } from '@/utils/localized-routes';

interface Props {
    lang?: Language;
}

const { lang = defaultLang } = Astro.props;
const t = getTranslations(lang);

// Get all featured projects in the current language
const featuredProjects = (await getFeaturedProjectsByLanguage(lang))
  .sort((a, b) => new Date(b.data.publishDate).getTime() - new Date(a.data.publishDate).getTime());

// Get all non-featured projects in the current language
const allProjects = await getProjectsByLanguage(lang);
const nonFeaturedProjects = allProjects
  .filter((project) => !project.data.isFeatured)
  .sort((a, b) => new Date(b.data.publishDate).getTime() - new Date(a.data.publishDate).getTime());
---

<section id={lang === 'es' ? 'proyectos' : (lang === 'no' ? 'prosjekter' : 'projects')} class="py-20 bg-secondary">
  <div class="w-full">
    <h2 class="h2 mb-8">{t('home.featuredProjects')}</h2>
    <ProjectCarousel projectCount={featuredProjects.length} class="overflow-hidden  py-2    lg:px-0">
      {featuredProjects.map((project, index) => (
        <ProjectCard
          name={project.data.name}
          hook={project.data.hook}
          href={getLocalizedUrl(lang, 'projects', getSlugFromId(project.id))}
          slug={getSlugFromId(project.id)}
          dataIndex={index + 1}
          tags={project.data.tags}
          publishDate={project.data.publishDate.toISOString()}
          lang={lang}
        />
      ))}
    </ProjectCarousel>

    {nonFeaturedProjects.length > 0 && (
      <div class="mt-16">
        <ProjectsTable
          projects={nonFeaturedProjects}
          startIndex={featuredProjects.length}
          lang={lang}
        />
      </div>
    )}
  </div>
</section>