---
import Button from './Button.astro';

interface Props {
  projectCount: number;
  class?: string;
}

const { projectCount, class: className = '' } = Astro.props;

// Generate unique ID for this carousel instance
const carouselId = `carousel-${Math.random().toString(36).substr(2, 9)}`;
---

{projectCount <= 3 ? (
  <!-- Simple grid for 3 or fewer projects -->
  <div class={`grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 ${className}`}>
    <slot />
  </div>
) : (
  <!-- Full carousel for more than 3 projects -->
  <div class={`relative ${className}`} data-carousel={carouselId}>
    <!-- Embla viewport -->
    <div class="overflow-visible" data-embla-viewport>
      <div class="flex" data-embla-container>
        <slot />
      </div>
    </div>

    <!-- Navigation controls -->
    <div class="flex justify-end items-center mt-8 gap-2" data-embla-controls>
      <div data-embla-prev-wrapper class="opacity-30 cursor-not-allowed">
        <Button type="button" filled={true} size="sm" class="carousel-control !w-12 !h-12 !p-0 flex items-center justify-center group pointer-events-none" disabled={true}>
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="transition-all duration-200 ease-out group-hover:scale-120 group-hover:stroke-[2.5]">
            <path d="m15 18-6-6 6-6"/>
          </svg>
        </Button>
      </div>

      <div data-embla-next-wrapper>
        <Button type="button" filled={true} size="sm" class="carousel-control !w-12 !h-12 !p-0 flex items-center justify-center group">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="transition-all duration-200 ease-out group-hover:scale-120 group-hover:stroke-[2.5]">
            <path d="m9 18 6-6-6-6"/>
          </svg>
        </Button>
      </div>
    </div>
  </div>
)}

<script>
  import EmblaCarousel from 'embla-carousel';
  import Autoplay from 'embla-carousel-autoplay';

  class ProjectCarousel {
    private emblaApi: any;
    private viewport: HTMLElement;
    private container: HTMLElement;
    private prevButton: HTMLButtonElement;
    private nextButton: HTMLButtonElement;
    private slides: HTMLElement[] = [];

    constructor(carouselElement: HTMLElement) {
      this.viewport = carouselElement.querySelector('[data-embla-viewport]') as HTMLElement;
      this.container = carouselElement.querySelector('[data-embla-container]') as HTMLElement;

      // Find buttons inside the wrappers
      const prevWrapper = carouselElement.querySelector('[data-embla-prev-wrapper]');
      const nextWrapper = carouselElement.querySelector('[data-embla-next-wrapper]');

      this.prevButton = prevWrapper?.querySelector('button') as HTMLButtonElement;
      this.nextButton = nextWrapper?.querySelector('button') as HTMLButtonElement;

      if (!this.viewport || !this.container || !this.prevButton || !this.nextButton) {
        import('@/utils/debug-logger').then(({ debugLogger }) => {
          debugLogger.error('ProjectCarousel: Required elements not found');
        });
        return;
      }

      this.init();
    }

    private init() {
      this.setupSlides();
      this.initEmbla();
      this.bindEvents();
    }

    private setupSlides() {
      // Get all direct children as slides and setup their styling
      this.slides = Array.from(this.container.children) as HTMLElement[];
      
      this.slides.forEach((slide, index) => {
        // Set up responsive slide sizing
        slide.classList.add('flex-shrink-0', 'px-2');
        if (index === 0) slide.classList.add('pl-0');
        if (index === this.slides.length - 1) slide.classList.add('pr-0');
        
        // Responsive width classes
        slide.classList.add('w-full', 'md:w-1/2', 'lg:w-1/3');
      });
    }

    private initEmbla() {
      // Embla options with responsive breakpoints
      const options = {
        loop: false,
        align: 'start' as const,
        slidesToScroll: 1,
        containScroll: 'trimSnaps' as const,
        breakpoints: {
          '(min-width: 768px)': { slidesToScroll: 2 },
          '(min-width: 1024px)': { slidesToScroll: 3 }
        }
      };

      // Initialize Embla with autoplay
      const autoplayOptions = {
        delay: 4000,
        stopOnInteraction: false,
        stopOnMouseEnter: true,
        stopOnFocusIn: true
      };

      this.emblaApi = EmblaCarousel(this.viewport, options, [Autoplay(autoplayOptions)]);
      
      // Set up event listeners
      this.emblaApi.on('select', this.onSelect.bind(this));
      this.emblaApi.on('init', this.onInit.bind(this));
    }

    private onInit() {
      this.updateButtons();
    }

    private onSelect() {
      this.updateButtons();
    }

    private updateButtons() {
      const canScrollPrev = this.emblaApi.canScrollPrev();
      const canScrollNext = this.emblaApi.canScrollNext();

      this.prevButton.disabled = !canScrollPrev;
      this.nextButton.disabled = !canScrollNext;

      // Update wrapper opacity and cursor
      const prevWrapper = this.prevButton.closest('[data-embla-prev-wrapper]') as HTMLElement;
      const nextWrapper = this.nextButton.closest('[data-embla-next-wrapper]') as HTMLElement;
      const controlsContainer = this.prevButton.closest('[data-embla-controls]') as HTMLElement;

      if (prevWrapper) {
        if (canScrollPrev) {
          prevWrapper.classList.remove('opacity-30', 'cursor-not-allowed');
          this.prevButton.classList.remove('pointer-events-none');
        } else {
          prevWrapper.classList.add('opacity-30', 'cursor-not-allowed');
          this.prevButton.classList.add('pointer-events-none');
        }
      }

      if (nextWrapper) {
        if (canScrollNext) {
          nextWrapper.classList.remove('opacity-30', 'cursor-not-allowed');
          this.nextButton.classList.remove('pointer-events-none');
        } else {
          nextWrapper.classList.add('opacity-30', 'cursor-not-allowed');
          this.nextButton.classList.add('pointer-events-none');
        }
      }

      // Hide controls container if both buttons are disabled
      if (controlsContainer) {
        if (!canScrollPrev && !canScrollNext) {
          controlsContainer.classList.add('hidden');
        } else {
          controlsContainer.classList.remove('hidden');
        }
      }
    }

    private bindEvents() {
      this.prevButton.addEventListener('click', () => {
        this.emblaApi.scrollPrev();
      });

      this.nextButton.addEventListener('click', () => {
        this.emblaApi.scrollNext();
      });

      // Pause autoplay on hover/focus
      this.viewport.addEventListener('mouseenter', () => {
        const autoplay = this.emblaApi.plugins().autoplay;
        if (autoplay) autoplay.stop();
      });

      this.viewport.addEventListener('mouseleave', () => {
        const autoplay = this.emblaApi.plugins().autoplay;
        if (autoplay) autoplay.play();
      });

      // Update buttons on window resize
      window.addEventListener('resize', () => {
        this.emblaApi.reInit();
        this.updateButtons();
      });
    }

    public destroy() {
      if (this.emblaApi) {
        this.emblaApi.destroy();
      }
    }
  }

  // Initialize all carousels on the page
  function initCarousels() {
    const carousels = document.querySelectorAll('[data-carousel]');
    const carouselInstances: ProjectCarousel[] = [];

    carousels.forEach(carousel => {
      const instance = new ProjectCarousel(carousel as HTMLElement);
      carouselInstances.push(instance);
    });

    // Clean up on page unload
    window.addEventListener('beforeunload', () => {
      carouselInstances.forEach(instance => instance.destroy());
    });
  }

  // Initialize on DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCarousels);
  } else {
    initCarousels();
  }

  // Re-initialize on Astro page navigation
  document.addEventListener('astro:page-load', initCarousels);
</script>

<style>
  /* Embla carousel specific styles */
  [data-embla-viewport] {
    overflow: visible;
    position: relative;
  }

  [data-embla-container] {
    display: flex;
  }

  /* Carousel control disabled state */
  .carousel-control:disabled {
    opacity: 0.3;
    pointer-events: none;
  }

  /* Ensure proper slide sizing */
  [data-embla-container] > * {
    min-width: 0;
  }

  /* Mobile responsive behavior */
  @media (max-width: 767px) {
    [data-embla-container] > * {
      flex: 0 0 100%;
    }
  }

  @media (min-width: 768px) and (max-width: 1023px) {
    [data-embla-container] > * {
      flex: 0 0 50%;
    }
  }

  @media (min-width: 1024px) {
    [data-embla-container] > * {
      flex: 0 0 33.333333%;
    }
  }
</style>