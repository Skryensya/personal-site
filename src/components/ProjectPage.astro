---
import { type CollectionEntry } from 'astro:content';
import Layout from '../layouts/Layout.astro';   
import ThemedImage from './ThemedImage.astro';
import Button from './Button.astro';
import ContentPage from './ContentPage.astro';

interface Props {
    projectsByLang: Record<string, CollectionEntry<'projects'>>;
    slug: string;
    currentLocale: "es" | "en" | "no";
}

const { projectsByLang, slug, currentLocale } = Astro.props;

// Get the project for the current language, fallback to Spanish if not available
const project = projectsByLang[currentLocale] || projectsByLang['es'] || Object.values(projectsByLang)[0];

if (!project) {
    return Astro.redirect('/404');
}

const { name, hook, seo, clientLogo } = project.data;
const { Content } = await project.render();
---

<Layout title={seo?.title ?? name} description={seo?.description ?? hook} image={seo?.image} pageType="article" showHeader={true} lang={currentLocale}>
    <article class="min-h-screen">
        <ContentPage 
            contentId="project-content"
            sidebarClassName="w-48"
            contentClassName="md:mb-64"
        >
                <!-- Content with project header -->
                <div class="py-8 px-2 lg:px-4 lg:py-4 flex flex-col items-center">
                    <!-- Project Title and Hook - Part of Content -->
                    <header class="pb-8 border-b border-dotted border-main/30 w-full" style={`max-width: var(--paragraph-max-width); view-transition-name: folder-body-${project.slug}`}>
                        <!-- Project Name and Reading Time -->
                        <div class="flex justify-between items-center mb-8">
                            <div class="text-base font-mono font-medium text-main opacity-60 uppercase tracking-wider" style={`view-transition-name: folder-tab-${project.slug}`}>
                                {name}
                            </div>
                            <div class="text-sm font-mono font-medium text-main opacity-50 uppercase tracking-wider" id="reading-time">
                                Calculando...
                            </div>
                        </div>
                        
                        <!-- Hook - Main Focus -->
                        {hook && (
                            <h1 class="text-2xl sm:text-3xl lg:text-4xl leading-snug text-main font-bold mb-10 text-pretty" style="max-width: var(--paragraph-max-width)">
                                {hook}
                            </h1>
                        )}
                        
                    </header>
                    
                    <!-- Article Content -->
                    <div class="prose w-full [&>p]:text-base [&>p]:lg:text-lg [&>p]:leading-relaxed [&>p]:mb-6 [&>h1]:text-4xl [&>h1]:font-bold [&>h1]:mt-12 [&>h1]:mb-6 [&>h1]:scroll-mt-12 [&>h2]:text-3xl [&>h2]:font-bold [&>h2]:mt-10 [&>h2]:mb-4 [&>h2]:scroll-mt-12 [&>h3]:text-2xl [&>h3]:font-semibold [&>h3]:mt-8 [&>h3]:mb-3 [&>h3]:scroll-mt-12 [&>h4]:text-xl [&>h4]:font-semibold [&>h4]:mt-6 [&>h4]:mb-2 [&>h4]:scroll-mt-12 [&>h5]:scroll-mt-12 [&>h6]:scroll-mt-12" style="max-width: var(--paragraph-max-width)">
                        <Content />
                    </div>
                </div>
        </ContentPage>

        <script is:inline>
            // Calculate reading time immediately
            function setReadingTime() {
                const readingTimeEl = document.getElementById('reading-time');
                if (!readingTimeEl) return;
                
                const content = document.querySelector('.prose') || document.querySelector('article');
                if (!content) {
                    readingTimeEl.textContent = '5 min lectura';
                    return;
                }
                
                const text = content.textContent || '';
                const words = text.trim().split(/\s+/).filter(function(w) { return w.length > 1; });
                const minutes = Math.max(2, Math.ceil(words.length / 200));
                readingTimeEl.textContent = minutes + ' min lectura';
            }

            // Animate statistics numbers
            function animateStats() {
                const elements = document.querySelectorAll('[data-target]');
                elements.forEach(function(el) {
                    const target = parseInt(el.getAttribute('data-target'));
                    let current = 0;
                    const increment = target / 50;
                    
                    const timer = setInterval(function() {
                        current += increment;
                        if (current >= target) {
                            current = target;
                            clearInterval(timer);
                        }
                        
                        let display = Math.floor(current).toLocaleString();
                        if (target === 100) display += '+';
                        el.textContent = display;
                    }, 60);
                });
            }

            // Initialize everything
            function init() {
                setReadingTime();
                setTimeout(animateStats, 500);
            }

            // Run when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }

            // Also run on Astro page transitions
            document.addEventListener('astro:page-load', init);
        </script>
    </article>
</Layout>

<!-- Preload client logo -->
{clientLogo && <link rel="preload" as="image" href={clientLogo} />}