---
import { getTranslations } from '@/i18n/utils';
import { defaultLang, type Language } from '@/i18n/ui';
import ThemedImage from '@/components/ThemedImage.astro';
import CVTag from '@/components/CVTag.tsx';
import { getSlugFromId } from '@/utils/content-utils';
import { getLocalizedUrl } from '@/utils/localized-routes';
import { getCollection, type CollectionEntry } from 'astro:content';

interface Props {
    lang?: Language;
}

const { lang = defaultLang } = Astro.props;
const t = getTranslations(lang);

// Get featured projects for this language
const allProjects = await getCollection('projects');
const featuredProjects: CollectionEntry<'projects'>[] = allProjects
    .filter((project: CollectionEntry<'projects'>) => project.id.startsWith(`${lang}/`) && project.data.isFeatured)
    .filter((project: CollectionEntry<'projects'>) => project.data.cvDescription) // Only show projects with CV descriptions
    .slice(0, 5); // Limit to 5 projects for CV
---

<div class="bg-transparent text-main">
    <div class="w-full">
        <!-- Professional Header with Image -->
        <header class="print:mb-4 print:!block">
            <div class="flex justify-between items-start print:flex">
                <div class="text-left flex-1">
                    <h1 class="text-4xl font-bold mb-1 pt-1">{t('cv.fullName')}</h1>
                    <p class="text-base font-semibold">{t('cv.jobTitle')}</p>
                </div>
                <a href="https://linkedin.com/in/skryensya" target="_blank" rel="noopener noreferrer" class="print:w-24 w-24 lg:w-28 aspect-square ml-6 flex-shrink-0 overflow-hidden rounded-full group">
                    <ThemedImage src="/img/me.png" alt="Allison PeÃ±a" class="w-full h-full group-hover:opacity-80 [&_img]:object-[50%_40%] [&_img]:filter [&_img]:grayscale [&_img]:contrast-125" />
                </a>
            </div>
        </header>

        <div class="flex flex-col lg:flex-row lg:flex-nowrap gap-5 mb-6">
            <!-- Left Sidebar: Contact Information -->
            <div class="lg:min-w-[220px] space-y-3">
                <section>
                    <h2 class="text-base font-bold uppercase border-b-2 border-main mb-2">{t('cv.contact')}</h2>

                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-1 gap-2 lg:space-y-2 lg:gap-0">
                        <!-- Location -->
                        <a href="https://maps.google.com/?q=Santiago,Chile" target="_blank" rel="noopener noreferrer" class="flex gap-1.5 group">
                            <svg class="w-4 h-4 text-main mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            <div>
                                <span class="font-bold uppercase text-sm block opacity-80">{t('cv.contact.location')}</span>
                                <span class="font-mono text-main block text-sm group-hover:underline">{t('cv.location.value')}</span>
                            </div>
                        </a>

                        <!-- Email -->
                        <a href={`mailto:${t('cv.email.value')}`} class="flex gap-1.5 group">
                            <svg class="w-4 h-4 text-main mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M3 8l7.89 4.73c.7.42 1.52.42 2.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                            </svg>
                            <div>
                                <span class="font-bold uppercase text-sm block opacity-80">{t('cv.contact.email')}</span>
                                <span class="font-mono text-main group-hover:underline group-hover:opacity-70 print:no-underline block text-xs break-all">
                                    {t('cv.email.value')}
                                </span>
                            </div>
                        </a>

                        <!-- Phone -->
                        <a href={`tel:${t('cv.phone.value').replace(/\s/g, '')}`} class="flex gap-1.5 group">
                            <svg class="w-4 h-4 text-main mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"
                                ></path>
                            </svg>
                            <div>
                                <span class="font-bold uppercase text-sm block opacity-80">{t('cv.contact.phone')}</span>
                                <span class="font-mono text-main group-hover:underline group-hover:opacity-70 print:no-underline block text-sm">
                                    {t('cv.phone.value')}
                                </span>
                            </div>
                        </a>

                        <!-- LinkedIn -->
                        <a href={`https://linkedin.com${t('cv.linkedin.value')}`} target="_blank" rel="noopener noreferrer" class="flex gap-1.5 group">
                            <svg class="w-4 h-4 text-main mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
                                <path
                                    d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"
                                ></path>
                            </svg>
                            <div>
                                <span class="font-bold uppercase text-sm block opacity-80">{t('cv.contact.linkedin')}</span>
                                <span class="font-mono text-main group-hover:underline group-hover:opacity-70 print:no-underline block text-sm">
                                    {t('cv.linkedin.value')}
                                </span>
                            </div>
                        </a>
                    </div>
                </section>

                <!-- Languages -->
                <section>
                    <h2 class="text-base font-bold uppercase border-b-2 border-main mb-2">{t('cv.languages.title')}</h2>
                    <div class="space-y-1.5">
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-mono">{t('cv.languages.spanish')}</span>
                            <CVTag text={t('cv.languages.spanish.level')} client:idle />
                        </div>
                        <a href="https://cert.efset.org/en/t9Ceeq" target="_blank" class="flex justify-between items-center group">
                            <span class="text-sm font-mono inline-flex group-hover:underline">{t('cv.languages.english')}

                  
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-external-link-icon lucide-external-link h-4 w-4 ml-1"><path d="M15 3h6v6"/><path d="M10 14 21 3"/><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/></svg>

                            </span>
                            <CVTag text={t('cv.languages.english.level')} client:idle />
                        </a>
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-mono">{t('cv.languages.norwegian')}</span>
                            <CVTag className="opacity-70" text={t('cv.languages.norwegian.level')} client:idle />
                        </div>
                    </div>
                </section>

                <!-- Certifications -->
                <section>
                    <h2 class="text-base font-bold uppercase border-b-2 border-main mb-2">{t('cv.certificates.title')}</h2>

                    <a href="https://courses.edx.org/certificates/6e99aff7d04448078c27ff817f4e1b49" target="_blank"  class="space-y-1.5 group">
                        <div class="border-l-4 border-main pl-3">
                            <div class="flex items-center gap-1.5 mb-1">
                                <span class="w-2 h-2 bg-main print:!bg-black"></span>
                                <h3 class="font-bold text-SM text-main">WAI0.1x</h3>
                            </div>
                            <div class="text-sm group-hover:underline flex">{t('cv.certificate.wai01x.description')}
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-external-link-icon lucide-external-link h-4 w-4 ml-1"><path d="M15 3h6v6"/><path d="M10 14 21 3"/><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/></svg>
                            </div>
                        </div>
                    </a>
                </section>

                <!-- References -->
                <section>
                    <h2 class="text-base font-bold uppercase border-b-2 border-main mb-2">{t('cv.references.title')}</h2>

                    <div class="space-y-2">
                        <!-- Reference 1 -->
                        <div class="border-l-4 border-main pl-3">
                            <div class="flex items-center gap-1.5 mb-1">
                                <span class="w-2 h-2 bg-main print:!bg-black"></span>
                                <h3 class="font-bold text-xs text-main">{t('cv.references.jorge.name')}</h3>
                            </div>
                            <p class="text-xs opacity-80 mb-1">{t('cv.references.position')}</p>
                            <a href={`mailto:${t('cv.references.jorge.email')}`} class="text-xs font-mono text-main hover:underline block break-all">
                                {t('cv.references.jorge.email')}
                            </a>
                        </div>

                        <!-- Reference 2 -->
                        <div class="border-l-4 border-main pl-3">
                            <div class="flex items-center gap-1.5 mb-1">
                                <span class="w-2 h-2 bg-main print:!bg-black"></span>
                                <h3 class="font-bold text-xs text-main">{t('cv.references.elias.name')}</h3>
                            </div>
                            <p class="text-xs opacity-80 mb-1">{t('cv.references.position')}</p>
                            <a href={`mailto:${t('cv.references.elias.email')}`} class="text-xs font-mono text-main hover:underline block break-all">
                                {t('cv.references.elias.email')}
                            </a>
                        </div>
                    </div>
                </section>

                <!-- QR -->
                <!-- <section class="hidden lg:block">
                    <h2 class="text-base font-bold uppercase border-b-2 border-main">{t('cv.website.title')}</h2>

                    <div class="w-full h-full overflow-hidden">
                        <ThemedImage src="/site-url-qr.svg" alt="Allison PeÃ±a" class="w-full h-full" />
               
                    </div>
                             <div class="flex justify-center print:block">
                            <a href="https://skryensya.dev" class="font-mono text-main block text-xs break-all mt-1 hover:underline print:inline"> {t('cv.website.value')} </a>
                        </div>
                </section> -->
            </div>

            <!-- Right Content: About Me, Experience and References -->
            <div class="space-y-4">
                <!-- Professional Summary -->
                <section>
                    <h2 class="text-base font-bold uppercase border-b-2 border-main mb-2">{t('cv.about.title')}</h2>
                    <p class="text-sm leading-snug italic">
                        {t('cv.about.content')}
                    </p>
                </section>

                <!-- Experience Section -->
                <section>
                    <h2 class="text-base font-bold uppercase border-b-2 border-main mb-2">{t('cv.experience.title')}</h2>
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <div class="text-2xl font-bold text-main">{t('cv.experience.company')}</div>
                            <p class="text-xs font-semibold text-main/80">{t('cv.experience.position')}</p>
                        </div>
                        <div class="text-xs font-semibold bg-main text-secondary px-2 py-0.5 mt-1">{t('cv.experience.period')}</div>
                    </div>
                    <p class="text-sm leading-relaxed italic mb-4">
                        {t('cv.experience.description')}
                    </p>

                    <!-- Featured Projects -->
                    <div class="mt-3">
                        <h2 class="text-base font-bold uppercase border-b-2 border-main mb-2">{t('cv.projects.title')}</h2>
                        <div class="space-y-2 pl-3 ml-2 border-l">
                            {featuredProjects.map((project: CollectionEntry<'projects'>) => (
                                <a
                                    href={getLocalizedUrl(lang, 'projects', getSlugFromId(project.id))}
                                    class="relative block rounded-sm px-2 py-1 -mx-2 transition-colors group hover:bg-main/10 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-main before:content-[''] before:absolute before:left-[-18px] before:top-3 before:h-3 before:w-3 before:rounded-full before:bg-secondary before:border before:border-main print:hover:bg-transparent print:before:!bg-white"
                                >
                                    <h4 class="font-bold text-sm text-main mb-0.5 group-hover:underline">
                                        {project.data.name}
                                    </h4>
                                    <p class="text-[15px] print:!text-sm mb-1 group-hover:text-main/90">
                                        {project.data.cvDescription}
                                    </p>
                                </a>
                            ))}
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>
</div>
