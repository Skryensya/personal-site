---
import siteConfig, { type Link } from '@/data/site-config';
import WaveDivider from './WaveDivider.astro';
import { Heart, ChevronRight, ExternalLink } from 'lucide-react';
import { getTranslations } from '@/i18n/utils';
import { defaultLang, type Language } from '@/i18n/ui';
import { getLocalizedUrl, getHomeUrl } from '@/utils/localized-routes';
import CircularText from '@/components/CircularText';

interface Props { 
  lang?: Language; 
}

interface NavigationLink {
  href: string;
  textKey: string;
  text: string;
}

const { lang = defaultLang } = Astro.props;
const t = getTranslations(lang);
const currentYear = new Date().getFullYear();

// Navigation links configuration
const navigationLinks: NavigationLink[] = [
  {
    href: getHomeUrl(lang),
    textKey: 'footer.home',
    text: t('footer.home')
  },
  {
    href: getLocalizedUrl(lang, 'projects'),
    textKey: 'footer.projects', 
    text: t('footer.projects')
  },
  {
    href: getLocalizedUrl(lang, 'resume'),
    textKey: 'footer.resume',
    text: t('footer.resume')
  },
  {
    href: lang === 'es' ? '/arbol-de-contenido/' : lang === 'en' ? '/en/content-tree/' : '/no/innholdstre/',
    textKey: '',
    text: lang === 'es' ? 'Árbol de contenido' : lang === 'en' ? 'Content Tree' : 'Innholdstre'
  },
  {
    href: getLocalizedUrl(lang, 'accessibility'),
    textKey: 'footer.accessibility',
    text: t('footer.accessibility')
  }
];
---

<footer class="bg-main border-t-double border-t-2 border-secondary">
  <WaveDivider inverted />
  <div class="mx-auto max-w-[var(--max-w-size)] px-4 pb-12">
    <!-- Main content flex - Mobile: stacked, Desktop: 83.33% content + 16.67% circle -->
    <div class="flex flex-col md:flex-row gap-8 mb-8">
      <!-- Content sections container - 83.33% on desktop -->
      <div class="flex flex-col md:flex-row gap-8 md:w-[83.33%] w-full">
        <!-- Navigation - 33.33% of content area -->
        <div class="md:w-[33.33%] w-full">
          <h3 class="font-mono text-sm font-bold text-secondary mb-4 uppercase scramble-text" data-text={t('footer.navigation')}>
            {t('footer.navigation')}
          </h3>
          <nav class="space-y-1">
            {navigationLinks.map((link) => (
              <a
                href={link.href}
                class="font-mono text-sm text-secondary hover:bg-secondary hover:text-main px-4 py-1.5 border-l-2 border-secondary scramble-text flex items-center justify-between group"
                data-text={link.text}
              >
                <span class="scramble-part">{link.text}</span>
                <ChevronRight size={14} className="text-secondary group-hover:text-main" client:idle />
              </a>
            ))}
          </nav>
        </div>

        <!-- Social - 33.33% of content area -->
        <div class="md:w-[33.33%] w-full">
          <h3 class="font-mono text-sm font-bold text-secondary mb-4 uppercase scramble-text" data-text={t('footer.connect')}>
            {t('footer.connect')}
          </h3>
          <nav class="space-y-1">
            {siteConfig.socialLinks?.map((link: Link) => (
              <a
                href={link.href}
                target="_blank"
                rel="noopener noreferrer"
                class="group font-mono text-sm text-secondary hover:bg-secondary hover:text-main px-4 py-1.5 border-l-2 border-secondary scramble-text flex items-center justify-between"
                data-text={`${link.text}`}
                data-has-external="true"
              >
                <span class="scramble-part">{link.text}</span>
                <ExternalLink size={14} className="text-secondary group-hover:text-main" client:idle />
              </a>
            ))}
          </nav>
        </div>

        <!-- Information - 33.33% of content area -->
        <div class="md:w-[33.33%] w-full">
          <h3 class="font-mono text-sm font-bold text-secondary mb-4 uppercase scramble-text" data-text={lang === 'es' ? 'Información' : lang === 'en' ? 'Information' : 'Informasjon'}>
            {lang === 'es' ? 'Información' : lang === 'en' ? 'Information' : 'Informasjon'}
          </h3>
          <nav class="space-y-2">
            <div class="block font-mono text-sm text-secondary px-2 py-1 scramble-text" data-text="Santiago, Chile">
              Santiago, Chile
            </div>
            <div class="block font-mono text-sm text-secondary px-2 py-1 scramble-text" data-text={lang === 'es' ? 'Disponible para proyectos' : lang === 'en' ? 'Available for projects' : 'Tilgjengelig for prosjekter'}>
              {lang === 'es' ? 'Disponible para proyectos' : lang === 'en' ? 'Available for projects' : 'Tilgjengelig for prosjekter'}
            </div>
          </nav>
        </div>
      </div>

      <!-- CircularText - 16.67% on desktop, full width on mobile -->
      <div class="md:w-[16.67%] w-full flex justify-center items-start" style="view-transition-name: none;">
        <CircularText client:load text="ALLISON PEÑA * SKRYENSYA * " onHover="speedUp" spinDuration={20}/>
      </div>
    </div>

    <!-- Copyright -->
    <div class="border-t-double border-t-2 border-secondary pt-6">
      <div class="flex flex-col md:flex-row justify-between items-center gap-4">
        <p class="font-mono text-sm text-secondary scramble-text" data-text={`© ${currentYear} ${siteConfig.title}. ${t('footer.copyright')}.`}>
          © {currentYear} {siteConfig.title}. {t('footer.copyright')}.
        </p>
        <p class="font-mono text-sm text-secondary scramble-text flex items-center gap-2" data-text={`${t('footer.builtWith')} ${t('footer.andCode')}`} data-has-heart="true">
          <span class="scramble-part">{t('footer.builtWith')}</span>
          <Heart size={14} className="text-secondary" fill="currentColor" client:idle />
          <span class="scramble-part">{t('footer.andCode')}</span>
        </p>
      </div>
    </div>
  </div>
</footer>

<script>
  document.addEventListener('astro:page-load', () => {
    let footerAnimated = false;

    // Scramble a single text node (span.scramble-part)
    function scrambleText(element: HTMLElement, originalText: string, duration: number = 800): void {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()_+-=[]{}|;:,.<>?';
      let i = 0;
      const stepMs = 30;
      const maxSteps = Math.ceil(duration / stepMs);

      const timer = setInterval(() => {
        const progress = Math.min(i / maxSteps, 1);
        const reveal = Math.floor(progress * originalText.length);

        element.textContent = originalText
          .split('')
          .map((_ch: string, idx: number) => (idx < reveal ? originalText[idx] : chars[Math.floor(Math.random() * chars.length)]))
          .join('');

        i++;
        if (progress >= 1) {
          clearInterval(timer);
          element.textContent = originalText; // ensure final
        }
      }, stepMs);
    }

    // Scramble only the .scramble-part children; never touch icons/components
    function scrambleContainer(container: HTMLElement): void {
      const parts = container.querySelectorAll('.scramble-part');
      if (parts.length) {
        parts.forEach((part: Element, idx: number) => {
          const el = part as HTMLElement;
          const txt = el.textContent || '';
          const delay = idx * 200;
          if (!txt.trim()) return;
          setTimeout(() => scrambleText(el, txt), delay);
        });
      } else {
        // fallback: if no .scramble-part, scramble the element text safely
        const txt = container.dataset.text || container.textContent || '';
        if (!txt.trim()) return;
        // Only scramble if the element has no child elements (avoid nuking icons)
        if (container.children.length === 0) {
          scrambleText(container, txt);
        }
      }
    }

    // Intersection Observer: run once when footer enters viewport
    const scrambleObserver = new IntersectionObserver((entries: IntersectionObserverEntry[]) => {
      entries.forEach((entry: IntersectionObserverEntry) => {
        if (entry.isIntersecting && !footerAnimated) {
          footerAnimated = true;
          const elements = document.querySelectorAll('.scramble-text');
          elements.forEach((el: Element, idx: number) => {
            setTimeout(() => scrambleContainer(el as HTMLElement), idx * 50);
          });
          scrambleObserver.disconnect();
        }
      });
    }, { threshold: 0.1, rootMargin: '50px' });

    const footer = document.querySelector('footer');
    if (footer) scrambleObserver.observe(footer);
  });
</script>

<style>
  footer::after {
    content: '';
    position: fixed;
    top: 100vh;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-color: var(--color-main);
    pointer-events: none;
    z-index: -1;
  }
</style>
