---
import DiagonalStripe from './DiagonalStripe.astro';
import { themes, themeKeys } from '../data/themes.js';

const navItems = [
  { label: 'ALLISON PEÃ‘A', href: '/', hotkey: null },
  { label: 'PROJECTS', href: '/projects', hotkey: 'p' },
  { label: 'BLOG', href: '/_blog', hotkey: 'b' },
  { label: 'ABOUT', href: '/about', hotkey: 'a' },
  { label: 'CONTACT', href: '/contact', hotkey: 'c' }
];
---

<div>
  <header class="fixed top-6 inset-x-6 md:inset-x-16  z-[100] pointer-events-none">
    <div class="flex items-start justify-between gap-2 flex-nowrap">
      <div class="flex items-start gap-x-2 gap-y-1 flex-wrap w-4/5">
        {navItems.map((item) => (
          <a 
            href={item.href}
            class="flex items-center gap-1.5 px-2 py-1 h-7 md:h-8 bg-secondary border border-main font-grotesk text-sm font-semibold text-main no-underline pointer-events-auto hover:bg-main hover:text-secondary active:bg-main active:text-secondary nav-link"
            data-hotkey={item.hotkey}
            aria-label={item.hotkey ? `${item.label} (Press ${item.hotkey.toUpperCase()})` : item.label}
          >
            {item.hotkey && <span class="text-xs font-bold font-mono">[{item.hotkey.toUpperCase()}]</span>}
            <span class="font-semibold">{item.label}</span>
          </a>
        ))}
      </div>

      <div class="flex flex-col md:flex-row items-center gap-1 pointer-events-auto">
        <!-- Mode Toggle -->
        <button id="mode-toggle" class="w-7 h-7 md:w-auto md:h-8 border border-main bg-secondary flex items-center justify-center hover:bg-main group md:px-2 md:gap-2" aria-label="Cambiar modo">
          <!-- Icon container with fixed size -->
          <div class="w-3.5 h-3.5 relative flex-shrink-0">
            <!-- Sun icon for light mode -->
            <svg class="w-3.5 h-3.5 text-main absolute inset-0 transition-opacity duration-150 group-hover:text-secondary sun-icon" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="5"/>
              <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
            </svg>
            
            <!-- Moon icon for dark mode -->
            <svg class="w-3.5 h-3.5 text-main absolute inset-0 transition-opacity duration-150 group-hover:text-secondary moon-icon opacity-0" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
              <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
            </svg>
          </div>
          
          <!-- Text labels for desktop -->
          <span class="hidden md:block font-mono text-xs font-semibold text-main transition-colors duration-150 group-hover:text-secondary mode-text">LIGHT</span>
        </button>

        <!-- Theme Selector -->
        <div class="relative theme-selector">
          <button id="theme-toggle" class="w-7 h-7 md:w-auto md:h-8 border border-main bg-secondary flex items-center justify-center hover:bg-main md:px-2 md:gap-2 group" aria-label="Cambiar tema">
            <div class="w-4 h-4 border border-main theme-preview-current void-preview md:flex-shrink-0"></div>
            <span class="hidden md:block font-mono text-xs font-semibold text-main transition-colors duration-150 group-hover:text-secondary theme-name-text">VOID</span>
          </button>
          
          <div class="absolute top-full mt-1 right-0 bg-secondary border border-main p-2 opacity-0 invisible transform -translate-y-2 transition-all duration-150 z-[100] theme-dropdown grid grid-cols-4 gap-2 min-w-[520px]">
            {themeKeys.map((themeKey, index) => {
              const theme = themes[themeKey];
              const isLastRow = index >= themeKeys.length - 4;
              return (
                <div 
                  class={`flex items-center gap-2 p-2 cursor-pointer ${!isLastRow ? 'border-b border-main' : ''} font-mono text-xs font-semibold text-main hover:bg-main hover:text-secondary theme-option whitespace-nowrap`} 
                  data-theme={themeKey}
                >
                  <div class={`w-3.5 h-3.5 border border-main flex-shrink-0 ${themeKey}-preview`}></div>
                  <span>{theme.name}</span>
                </div>
              );
            })}
            <div class="col-span-4 bg-main border-t border-main p-2 flex justify-between items-center gap-2 font-mono text-xs font-semibold text-secondary">
              <span class="cursor-pointer hover:text-main hover:bg-secondary p-1" data-hotkey="[">PREV [</span>
              <span class="cursor-pointer hover:text-main hover:bg-secondary p-1" data-hotkey="]">NEXT ]</span>
              <span class="cursor-pointer hover:text-main hover:bg-secondary p-1" data-hotkey="_">RANDOM _</span>
            </div>
          </div>
        </div>

        <!-- CRT Toggle -->
        <button id="crt-toggle" class="w-7 h-7 md:w-auto md:h-8 border border-main bg-secondary flex items-center justify-center relative transition-all duration-150 md:px-2 md:gap-2 group" aria-label="Toggle CRT effect">
          <!-- CRT Monitor Icon -->
          <svg class="w-5 h-6 text-main transition-colors duration-150" fill="none" stroke="currentColor" stroke-width="1.2" viewBox="0 0 24 24">
            <!-- Monitor screen (centered in button) -->
            <rect class="crt-screen" width="12" height="8" x="6" y="6" stroke="currentColor" fill="none" rx="0.5"/>
            <!-- Monitor bezel -->
            <rect width="13" height="9" x="5.5" y="5.5" stroke="currentColor" fill="none" stroke-width="0.8" opacity="0.6"/>
            <!-- Monitor base -->
            <rect width="6" height="1" x="9" y="16" fill="currentColor" rx="0.2"/>
            <!-- Monitor stand -->
            <rect width="1.5" height="2" x="11.25" y="14.5" fill="currentColor" rx="0.2"/>
            <!-- CRT Animation - scrolling scanlines inside screen -->
            <g class="crt-animation opacity-0 transition-opacity duration-150" clip-path="url(#screenClip)">
              <!-- Define clipping path for screen area -->
              <defs>
                <clipPath id="screenClip">
                  <rect width="12" height="8" x="6" y="6" rx="0.5"/>
                </clipPath>
              </defs>
              
              <!-- Scrolling scanlines -->
              <g class="scanline-group">
                <line x1="6.5" y1="7" x2="17.5" y2="7" stroke="rgba(255,255,255,0.3)" stroke-width="0.4">
                  <animateTransform attributeName="transform" type="translate" values="0,-2; 0,9" dur="1.5s" repeatCount="indefinite"/>
                </line>
                <line x1="6.5" y1="9" x2="17.5" y2="9" stroke="rgba(255,255,255,0.2)" stroke-width="0.4">
                  <animateTransform attributeName="transform" type="translate" values="0,-2; 0,9" dur="1.8s" repeatCount="indefinite"/>
                </line>
                <line x1="6.5" y1="11" x2="17.5" y2="11" stroke="rgba(255,255,255,0.25)" stroke-width="0.4">
                  <animateTransform attributeName="transform" type="translate" values="0,-2; 0,9" dur="1.3s" repeatCount="indefinite"/>
                </line>
                <line x1="6.5" y1="13" x2="17.5" y2="13" stroke="rgba(255,255,255,0.15)" stroke-width="0.4">
                  <animateTransform attributeName="transform" type="translate" values="0,-2; 0,9" dur="2s" repeatCount="indefinite"/>
                </line>
              </g>
            </g>
          </svg>
          <span class="hidden md:block font-mono text-xs font-semibold text-main transition-colors duration-150 group-hover:text-secondary">CRT</span>
        </button>
    </div>
  </header>
  
  <DiagonalStripe height="120px" margin="16" />
</div>

<script>
  document.addEventListener('astro:page-load', () => {
    // Navigation elements
    const navLinks = document.querySelectorAll('.nav-link');
    const currentPath = window.location.pathname;

    // Theme elements
    const themeToggle = document.getElementById('theme-toggle');
    const themeDropdown = document.querySelector('.theme-dropdown');
    const themeOptions = document.querySelectorAll('.theme-option');
    const modeToggle = document.getElementById('mode-toggle');
    const currentThemePreview = document.querySelector('.theme-preview-current');
    const themeNameText = document.querySelector('.theme-name-text');
    const modeText = document.querySelector('.mode-text');
    const crtToggle = document.getElementById('crt-toggle');

    // Load saved settings
    const savedTheme = localStorage.getItem('theme') || 'void';
    const savedMode = localStorage.getItem('mode') || 'light';
    const savedCrt = localStorage.getItem('crt') === 'true';
    
    let lastThemeChange = 0;
    const themeChangeDelay = 150; // milliseconds
    
    applyTheme(savedTheme);
    applyMode(savedMode);
    applyCrt(savedCrt);
    updateActiveThemeOption(savedTheme);
    updateCurrentThemePreview(savedTheme);

    // Get all theme names from data attributes
    const allThemes = Array.from(themeOptions).map(option => (option as HTMLElement).dataset.theme).filter(Boolean);
    let currentThemeIndex = allThemes.indexOf(savedTheme);

    // Navigation: Set active state based on current page
    navLinks.forEach(link => {
      const href = link.getAttribute('href');
      if (href && (href === currentPath || (currentPath.startsWith(href) && href !== '/'))) {
        link.classList.add('!bg-main', '!text-secondary');
      }
      
      // Prevent default click behavior and handle on mouseup
      link.addEventListener('click', (e: Event) => {
        e.preventDefault();
      });
      
      link.addEventListener('mouseup', () => {
        const href = link.getAttribute('href');
        if (href) {
          window.location.href = href;
        }
      });
    });

    // Mode toggle (dark/light)
    modeToggle?.addEventListener('click', () => {
      const isDark = document.documentElement.classList.contains('dark');
      const newMode = isDark ? 'light' : 'dark';
      applyMode(newMode);
      localStorage.setItem('mode', newMode);
    });

    // CRT effect toggle
    crtToggle?.addEventListener('click', () => {
      const hasCrt = document.documentElement.classList.contains('crt-effect');
      const newCrt = !hasCrt;
      applyCrt(newCrt);
      localStorage.setItem('crt', newCrt.toString());
      if (newCrt) {
        crtOnSound.play();
      } else {
        crtOffSound.play();
      }
    });

    // Theme dropdown toggle
    themeToggle?.addEventListener('click', (e: Event) => {
      e.stopPropagation();
      themeDropdown?.classList.toggle('opacity-0');
      themeDropdown?.classList.toggle('invisible');
      themeDropdown?.classList.toggle('-translate-y-2');
    });

    // Handle theme selection
    themeOptions.forEach(option => {
      option.addEventListener('click', (e: Event) => {
        e.stopPropagation();
        const theme = (option as HTMLElement).dataset.theme;
        if (theme) {
          applyTheme(theme);
          localStorage.setItem('theme', theme);
          updateActiveThemeOption(theme);
          updateCurrentThemePreview(theme);
          currentThemeIndex = allThemes.indexOf(theme);
          themeDropdown?.classList.add('opacity-0', 'invisible', '-translate-y-2');
        }
      });
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', () => {
      themeDropdown?.classList.add('opacity-0', 'invisible', '-translate-y-2');
    });

    // Keyboard navigation
    function handleKeydown(e: KeyboardEvent) {
      // Only trigger if not typing in an input
      const target = e.target as HTMLElement;
      if (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA') return;
      
      const key = e.key.toLowerCase();
      const navLink = document.querySelector(`[data-hotkey="${key}"]`) as HTMLElement;
      
      if (navLink && navLink.dataset.hotkey && !e.ctrlKey && !e.metaKey && !e.altKey) {
        e.preventDefault();
        
        // Visual feedback
        navLink.classList.add('!bg-main', '!text-secondary');
        setTimeout(() => {
          navLink.classList.remove('!bg-main', '!text-secondary');
        }, 150);
        
        // Navigate
        const href = navLink.getAttribute('href');
        if (href) {
          window.location.href = href;
        }
      }

      // Theme hotkeys with throttling
      const currentTime = Date.now();
      if (currentTime - lastThemeChange < themeChangeDelay) {
        return; // Throttle rapid key presses
      }

      if (key === '[') { // Previous theme
        currentThemeIndex = (currentThemeIndex - 1 + allThemes.length) % allThemes.length;
        const newTheme = allThemes[currentThemeIndex];
        applyTheme(newTheme);
        localStorage.setItem('theme', newTheme);
        updateActiveThemeOption(newTheme);
        updateCurrentThemePreview(newTheme);
        lastThemeChange = currentTime;
      } else if (key === ']') { // Next theme
        currentThemeIndex = (currentThemeIndex + 1) % allThemes.length;
        const newTheme = allThemes[currentThemeIndex];
        applyTheme(newTheme);
        localStorage.setItem('theme', newTheme);
        updateActiveThemeOption(newTheme);
        updateCurrentThemePreview(newTheme);
        lastThemeChange = currentTime;
      } else if (key === '_') { // Random theme
        let randomIndex = currentThemeIndex;
        while (randomIndex === currentThemeIndex) {
          randomIndex = Math.floor(Math.random() * allThemes.length);
        }
        currentThemeIndex = randomIndex;
        const newTheme = allThemes[currentThemeIndex];
        applyTheme(newTheme);
        localStorage.setItem('theme', newTheme);
        updateActiveThemeOption(newTheme);
        updateCurrentThemePreview(newTheme);
        lastThemeChange = currentTime;
      }
    }

    document.addEventListener('keydown', handleKeydown);

    // Theme functions
    function applyTheme(theme: string) {
      document.documentElement.setAttribute('data-theme', theme);
    }

    function applyMode(mode: string) {
      document.documentElement.classList.toggle('dark', mode === 'dark');
      
      // Update icon visibility
      const sunIcon = document.querySelector('.sun-icon');
      const moonIcon = document.querySelector('.moon-icon');
      
      if (mode === 'dark') {
        sunIcon?.classList.add('opacity-0');
        sunIcon?.classList.remove('opacity-100');
        moonIcon?.classList.add('opacity-100');
        moonIcon?.classList.remove('opacity-0');
        if (modeText) modeText.textContent = 'DARK';
      } else {
        sunIcon?.classList.add('opacity-100');
        sunIcon?.classList.remove('opacity-0');
        moonIcon?.classList.add('opacity-0');
        moonIcon?.classList.remove('opacity-100');
        if (modeText) modeText.textContent = 'LIGHT';
      }
    }

    function updateActiveThemeOption(theme: string) {
      themeOptions.forEach(option => {
        if ((option as HTMLElement).dataset.theme === theme) {
          option.classList.add('!bg-main', '!text-secondary');
        } else {
          option.classList.remove('!bg-main', '!text-secondary');
        }
      });
    }

    function updateCurrentThemePreview(theme: string) {
      if (currentThemePreview) {
        currentThemePreview.className = `w-4 h-4 border border-main theme-preview-current ${theme}-preview md:flex-shrink-0`;
      }
      // Update theme name text
      if (themeNameText) {
        // Get theme name from themes data or fallback to uppercase theme key
        const themeName = getThemeName(theme);
        themeNameText.textContent = themeName;
      }
    }
    
    function getThemeName(theme: string): string {
      // Get theme name from imported themes data
      const themesModule = typeof window !== 'undefined' && (window as any).themes;
      if (themesModule && themesModule[theme]) {
        return themesModule[theme].name;
      }
      
      // Fallback theme names for current themes
      const themeNames: Record<string, string> = {
        'void': 'VOID',
        'phantom': 'PHANTOM',
        'bloom': 'BLOOM',
        'crimson': 'CRIMSON',
        'azure': 'AZURE',
        'volt': 'VOLT',
        'forest': 'FOREST',
        'ember': 'EMBER',
        'flame': 'FLAME',
        'violet': 'VIOLET',
        'plasma': 'PLASMA',
        'solar': 'SOLAR',
        'frost': 'FROST',
        'neon': 'NEON',
        'pulse': 'PULSE',
        'prism': 'PRISM'
      };
      return themeNames[theme] || theme.toUpperCase();
    }

    function applyCrt(enabled: boolean) {
      document.documentElement.classList.toggle('crt-effect', enabled);
      
      // Update button visual state
      if (crtToggle) {
        const screen = crtToggle.querySelector('.crt-screen');
        const animation = crtToggle.querySelector('.crt-animation');
        
        if (enabled) {
          // Active state: only fill the monitor screen, not the whole button
          screen?.setAttribute('fill', 'currentColor');
          animation?.classList.remove('opacity-0');
          animation?.classList.add('opacity-100');
        } else {
          // Inactive state: outline screen, no animation
          screen?.setAttribute('fill', 'none');
          animation?.classList.remove('opacity-100');
          animation?.classList.add('opacity-0');
        }
      }
    }

    // Show hotkey hints on first visit
    const hasSeenHints = localStorage.getItem('nav-hints-seen');
    if (!hasSeenHints) {
      setTimeout(() => {
        const hints = document.createElement('div');
        hints.innerHTML = `
          <div style="
            position: fixed; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            background: rgba(0,0,0,0.9); 
            color: white; 
            padding: 1rem; 
            border-radius: 8px; 
            font-size: 0.875rem;
            z-index: 1000;
            backdrop-filter: blur(10px);
          ">
            ðŸ’¡ Tip: Use keyboard shortcuts to navigate (P, B, A, C)
            <button onclick="this.parentElement.parentElement.remove(); localStorage.setItem('nav-hints-seen', 'true')" 
                    style="margin-left: 1rem; padding: 0.25rem 0.5rem; background: transparent; border: 1px solid white; color: white; border-radius: 4px; cursor: pointer;">
              Got it
            </button>
          </div>
        `;
        document.body.appendChild(hints);
      }, 2000);
    }
  });
</script>

<style>
  /* Theme previews with refined colors and diagonal gradients */
  .void-preview { 
    background: linear-gradient(45deg, #f8f9fa 50%, #0d1117 50%); 
    border-color: #0d1117 !important;
  }
  .phantom-preview { 
    background: linear-gradient(45deg, #39ff14 50%, #0a1a0a 50%); 
    border-color: #0a1a0a !important;
    box-shadow: 0 0 8px rgba(57, 255, 20, 0.3);
  }
  .bloom-preview { 
    background: linear-gradient(45deg, #ff6b9d 50%, #2d1b20 50%); 
    border-color: #2d1b20 !important;
  }
  .crimson-preview { 
    background: linear-gradient(45deg, #ff073a 50%, #220a0a 50%); 
    border-color: #220a0a !important;
    box-shadow: 0 0 8px rgba(255, 7, 58, 0.3);
  }
  .azure-preview { 
    background: linear-gradient(45deg, #007fff 50%, #0a1a2e 50%); 
    border-color: #0a1a2e !important;
  }
  .volt-preview { 
    background: linear-gradient(45deg, #ffff00 50%, #2e2e0a 50%); 
    border-color: #2e2e0a !important;
    box-shadow: 0 0 8px rgba(255, 255, 0, 0.3);
  }
  .forest-preview { 
    background: linear-gradient(45deg, #228b22 50%, #0f1f0f 50%); 
    border-color: #0f1f0f !important;
  }
  .ember-preview { 
    background: linear-gradient(45deg, #ff6347 50%, #2e1a0f 50%); 
    border-color: #2e1a0f !important;
  }
  .flame-preview { 
    background: linear-gradient(45deg, #ff4500 50%, #2e1500 50%); 
    border-color: #2e1500 !important;
  }
  .violet-preview { 
    background: linear-gradient(45deg, #9932cc 50%, #1a0f2e 50%); 
    border-color: #1a0f2e !important;
  }
  .plasma-preview { 
    background: linear-gradient(45deg, #00ffff 50%, #0a2e2e 50%); 
    border-color: #0a2e2e !important;
    box-shadow: 0 0 8px rgba(0, 255, 255, 0.3);
  }
  .solar-preview { 
    background: linear-gradient(45deg, #ffa500 50%, #2e1f0a 50%); 
    border-color: #2e1f0a !important;
  }
  .frost-preview { 
    background: linear-gradient(45deg, #4fbdba 50%, #0f2e2d 50%); 
    border-color: #0f2e2d !important;
  }
  .neon-preview { 
    background: linear-gradient(45deg, #ff00ff 50%, #2e0a2e 50%); 
    border-color: #2e0a2e !important;
    box-shadow: 0 0 8px rgba(255, 0, 255, 0.3);
  }
  .pulse-preview { 
    background: linear-gradient(45deg, #ff1493 50%, #2e0f1f 50%); 
    border-color: #2e0f1f !important;
  }
  .prism-preview { 
    background: linear-gradient(45deg, var(--user-selection-color) 50%, #1a1a1a 50%); 
    border-color: #1a1a1a !important;
  }

  /* Mode icon states */
  html:not(.dark) .sun-icon {
    opacity: 1;
  }

  html:not(.dark) .moon-icon {
    opacity: 0;
  }

  html.dark .sun-icon {
    opacity: 0;
  }

  html.dark .moon-icon {
    opacity: 1;
  }
</style>