--- 
import { themes } from '../data/themes.js';
import Dropdown from './Dropdown.astro';

const navItems = [
  { label: 'ALLISON PEÑA', href: '/', hotkey: null },
  { label: 'PROJECTS', href: '/projects', hotkey: 'p' },
  { label: 'BLOG', href: '/_blog', hotkey: 'b' },
  { label: 'ABOUT', href: '/about', hotkey: 'a' },
  { label: 'CONTACT', href: '/contact', hotkey: 'c' }
];

---

 
<header class="sticky top-4 z-[100] flex justify-center">
  <div class="max-w-[1280px] w-full px-4">
    <div class="flex items-start justify-between gap-2 flex-nowrap diagonal-stripe px-4 py-2">
      <div class="flex items-start gap-x-2 gap-y-1 flex-wrap w-4/5">
        {navItems.map((item) => (
          <a 
            href={item.href}
            class="flex items-center gap-1.5 px-2 py-1 h-7 md:h-8 bg-secondary border border-main font-grotesk text-sm !font-thin text-main no-underline pointer-events-auto hover:bg-main hover:text-secondary active:bg-main active:text-secondary nav-link"
            data-hotkey={item.hotkey}
            aria-label={item.hotkey ? `${item.label} (Press ${item.hotkey.toUpperCase()})` : item.label}
          >
            {item.hotkey && <span class="text-xs font-bold font-mono">[{item.hotkey.toUpperCase()}]</span>}
            <span class="font-semibold">{item.label}</span>
          </a>
        ))}
      </div>

      <div class="flex flex-col md:flex-row items-center gap-1 pointer-events-auto">
        <!-- Mode Dropdown -->
        <Dropdown id="mode">
          <div slot="trigger" class="w-3.5 h-3.5 relative flex-shrink-0">
            <svg class="w-3.5 h-3.5 text-main absolute inset-0 duration-150 group-hover:text-secondary sun-icon" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="5"/>
              <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
            </svg>
            <svg class="w-3.5 h-3.5 text-main absolute inset-0 duration-150 group-hover:text-secondary moon-icon opacity-0" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
              <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
            </svg>
            <svg class="w-3.5 h-3.5 text-main absolute inset-0 duration-150 group-hover:text-secondary system-icon opacity-0" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
              <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
              <line x1="8" y1="21" x2="16" y2="21"/>
              <line x1="12" y1="17" x2="12" y2="21"/>
            </svg>
          </div>
          <span slot="trigger" class="hidden md:block font-mono text-xs font-semibold text-main group-hover:text-secondary mode-text">LIGHT</span>
          
          <div class="grid gap-0">
            <div 
              class="flex items-center gap-2 p-1 cursor-pointer font-mono text-xs font-semibold text-main hover:bg-main hover:text-secondary dropdown-option mode-option whitespace-nowrap border-b border-main"
              data-mode="light"
              role="menuitem"
              tabindex="-1"
            >
              <svg class="w-3 h-3 flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="5"/>
                <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
              </svg>
              <span class="flex-1 px-1">LIGHT</span>
              <svg class="w-2.5 h-2.5 opacity-0 mode-checkmark" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                <path d="M20 6 9 17l-5-5"/>
              </svg>
            </div>
            <div 
              class="flex items-center gap-2 p-1 cursor-pointer font-mono text-xs font-semibold text-main hover:bg-main hover:text-secondary dropdown-option mode-option whitespace-nowrap border-b border-main"
              data-mode="dark"
              role="menuitem"
              tabindex="-1"
            >
              <svg class="w-3 h-3 flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
              </svg>
              <span class="flex-1 px-1">DARK</span>
              <svg class="w-2.5 h-2.5 opacity-0 mode-checkmark" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                <path d="M20 6 9 17l-5-5"/>
              </svg>
            </div>
            <div 
              class="flex items-center gap-2 p-1 cursor-pointer font-mono text-xs font-semibold text-main hover:bg-main hover:text-secondary dropdown-option mode-option whitespace-nowrap"
              data-mode="system"
              role="menuitem"
              tabindex="-1"
            >
              <svg class="w-3 h-3 flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
                <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
                <line x1="8" y1="21" x2="16" y2="21"/>
                <line x1="12" y1="17" x2="12" y2="21"/>
              </svg>
              <span class="flex-1 px-1">SYSTEM</span>
              <svg class="w-2.5 h-2.5 opacity-0 mode-checkmark" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                <path d="M20 6 9 17l-5-5"/>
              </svg>
            </div>
          </div>
        </Dropdown>

        <!-- Theme Dropdown -->
        <Dropdown id="theme">
          <div slot="trigger" class="w-4 h-4 border border-main theme-preview-current void-preview md:flex-shrink-0"></div>
          <span slot="trigger" class="hidden md:block font-mono text-xs font-semibold text-main group-hover:text-secondary theme-name-text">TEMAS</span>
          
          <div class="grid gap-0">
            {themes.map((theme) => {
              return (
                <div 
                  class="flex items-center gap-2 p-1 cursor-pointer font-mono text-xs font-semibold text-main hover:bg-main hover:text-secondary dropdown-option theme-option whitespace-nowrap border-b border-main last:border-b-0"
                  data-theme={theme.id}
                  role="menuitem"
                  tabindex="-1"
                >
                  <div 
                    class="w-3 h-3 border border-main flex-shrink-0 theme-preview-sample"
                    style={theme.id === 'custom' ? '' : `background: linear-gradient(135deg, ${theme.colorful} 50%, ${theme.contrasty} 50%)`}
                    data-custom-header-preview={theme.id === 'custom' ? 'true' : 'false'}
                  >
                    {theme.id === 'custom' && (
                      <div class="w-full h-full flex items-center justify-center text-[8px] font-bold">⚙</div>
                    )}
                  </div>
                  <span class="flex-1 px-1">{theme.name}</span>
                  <svg class="w-2.5 h-2.5 opacity-0 theme-checkmark" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                    <path d="M20 6 9 17l-5-5"/>
                  </svg>
                </div>
              );
            })}
          </div>
          <div class="border-t border-main bg-main p-1 flex justify-between items-center gap-1 font-mono text-xs font-semibold text-secondary">
            <button class="hover:text-main hover:bg-secondary px-1 py-0.5" data-hotkey="[">PREV [</button>
            <button class="hover:text-main hover:bg-secondary px-1 py-0.5" data-hotkey="]">NEXT ]</button>
            <button class="hover:text-main hover:bg-secondary px-1 py-0.5" data-hotkey="_">RANDOM _</button>
          </div>
        </Dropdown>

    </div>
    </div>
  
  </header>
  

 

<script>
  import { applyTheme, loadThemeFromStorage } from '../data/themes.js';
  
  document.addEventListener('astro:page-load', () => {
    // Navigation elements
    const navLinks = document.querySelectorAll('.nav-link');
    const currentPath = window.location.pathname;

    // Theme and mode elements
    const themeOptions = document.querySelectorAll('.theme-option');
    const modeOptions = document.querySelectorAll('.mode-option');
    const currentThemePreview = document.querySelector('.theme-preview-current');
    const themeNameText = document.querySelector('.theme-name-text');
    const modeText = document.querySelector('.mode-text');
    
    // Load saved settings with system preference support
    const savedTheme = localStorage.getItem('theme') || 'void';
    const savedModePreference = localStorage.getItem('mode-preference') || 'light';
    
    // Functions for system preference detection
    function getSystemPreference() {
      return window.matchMedia('(prefers-color-scheme: dark)').matches;
    }
    
    function getEffectiveMode(modePreference:any) {
      if (modePreference === 'system') {
        return getSystemPreference() ? 'dark' : 'light';
      }
      return modePreference;
    }
    
    let lastThemeChange = 0;
    const themeChangeDelay = 150; // milliseconds
    let currentModePreference = savedModePreference;
    
    // Apply initial settings
    applyTheme(savedTheme);
    const effectiveMode = getEffectiveMode(currentModePreference);
    applyMode(effectiveMode, currentModePreference);
    // Apply CRT effect permanently
    document.documentElement.classList.add('crt-effect');
    updateActiveThemeOption(savedTheme);
    updateCurrentThemePreview(savedTheme);
    updateActiveModeOption(currentModePreference);
    
    // Listen for system preference changes
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
      if (currentModePreference === 'system') {
        const newEffectiveMode = getEffectiveMode('system');
        applyMode(newEffectiveMode, 'system');
      }
    });

    // Get all theme names from data attributes
    const allThemes = Array.from(themeOptions).map(option => (option as HTMLElement).dataset.theme).filter(Boolean);
    let currentThemeIndex = allThemes.indexOf(savedTheme);

    // Navigation: Set active state based on current page
    navLinks.forEach(link => {
      const href = link.getAttribute('href');
      if (href && (href === currentPath || (currentPath.startsWith(href) && href !== '/'))) {
        link.classList.add('!bg-main', '!text-secondary');
      }
      
      // Prevent default click behavior and handle on mouseup
      link.addEventListener('click', (e: Event) => {
        e.preventDefault();
      });
      
      link.addEventListener('mouseup', () => {
        const href = link.getAttribute('href');
        if (href) {
          window.location.href = href;
        }
      });
    });

    // Handle mode selection
    modeOptions.forEach(option => {
      option.addEventListener('click', (e: Event) => {
        e.stopPropagation();
        const modePreference = (option as HTMLElement).dataset.mode;
        if (modePreference) {
          currentModePreference = modePreference;
          const effectiveMode = getEffectiveMode(modePreference);
          applyMode(effectiveMode, modePreference);
          localStorage.setItem('mode-preference', modePreference);
          updateActiveModeOption(modePreference);
        }
      });
    });

    // Handle theme selection
    themeOptions.forEach(option => {
      option.addEventListener('click', (e: Event) => {
        e.stopPropagation();
        const theme = (option as HTMLElement).dataset.theme;
        if (theme) {
          if (theme === 'custom') {
            // Check if we have saved custom colors in localStorage
            const hasCustomColors = localStorage.getItem('custom-theme-colors') !== null;
            const currentMode = document.documentElement.classList.contains('dark');
            
            if (!hasCustomColors) {
              // No custom colors saved, use defaults and apply immediately
              const defaultCustomColors = { colorful: '#3b82f6', contrasty: '#1e293b', name: 'CUSTOM' };
              applyTheme('custom');
              localStorage.setItem('theme-id', 'custom');
              localStorage.setItem('theme', 'custom'); // Keep both for compatibility
            } 
            
            updateActiveThemeOption(theme);
            updateCurrentThemePreview(theme);
            currentThemeIndex = allThemes.indexOf(theme);
          } else {
            applyTheme(theme);
            localStorage.setItem('theme-id', theme);
            localStorage.setItem('theme', theme); // Keep both for compatibility
            updateActiveThemeOption(theme);
            updateCurrentThemePreview(theme);
            currentThemeIndex = allThemes.indexOf(theme);
          }
        }
      });
    });

    // Keyboard navigation
    function handleKeydown(e: KeyboardEvent) {
      // Only trigger if not typing in an input
      const target = e.target as HTMLElement;
      if (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA') return;
      
      const key = e.key.toLowerCase();
      const navLink = document.querySelector(`[data-hotkey="${key}"]`) as HTMLElement;
      
      if (navLink && navLink.dataset.hotkey && !e.ctrlKey && !e.metaKey && !e.altKey) {
        e.preventDefault();
        
        // Visual feedback
        navLink.classList.add('!bg-main', '!text-secondary');
        setTimeout(() => {
          navLink.classList.remove('!bg-main', '!text-secondary');
        }, 150);
        
        // Navigate
        const href = navLink.getAttribute('href');
        if (href) {
          window.location.href = href;
        }
      }

      // Theme hotkeys with throttling
      const currentTime = Date.now();
      if (currentTime - lastThemeChange < themeChangeDelay) {
        return; // Throttle rapid key presses
      }

      if (key === '[') { // Previous theme
        currentThemeIndex = (currentThemeIndex - 1 + allThemes.length) % allThemes.length;
        const newTheme = allThemes[currentThemeIndex];
        if (newTheme) {
          applyTheme(newTheme);
          localStorage.setItem('theme', newTheme);
          updateActiveThemeOption(newTheme);
          updateCurrentThemePreview(newTheme);
          lastThemeChange = currentTime;
        }
      } else if (key === ']') { // Next theme
        currentThemeIndex = (currentThemeIndex + 1) % allThemes.length;
        const newTheme = allThemes[currentThemeIndex];
        if (newTheme) {
          applyTheme(newTheme);
          localStorage.setItem('theme', newTheme);
          updateActiveThemeOption(newTheme);
          updateCurrentThemePreview(newTheme);
          lastThemeChange = currentTime;
        }
      } else if (key === '_') { // Random theme
        let randomIndex = currentThemeIndex;
        while (randomIndex === currentThemeIndex) {
          randomIndex = Math.floor(Math.random() * allThemes.length);
        }
        currentThemeIndex = randomIndex;
        const newTheme = allThemes[currentThemeIndex];
        if (newTheme) {
          applyTheme(newTheme);
          localStorage.setItem('theme', newTheme);
          updateActiveThemeOption(newTheme);
          updateCurrentThemePreview(newTheme);
          lastThemeChange = currentTime;
        }
      }
    }

    document.addEventListener('keydown', handleKeydown);

    // Theme functions
    function applyTheme(theme: string) {
      document.documentElement.setAttribute('data-theme', theme);
    }

    function applyMode(mode: string, modePreference: string = mode) {
      document.documentElement.classList.toggle('dark', mode === 'dark');
      
      // Update icon visibility
      const sunIcon = document.querySelector('.sun-icon');
      const moonIcon = document.querySelector('.moon-icon');
      const systemIcon = document.querySelector('.system-icon');
      
      // Hide all icons first
      sunIcon?.classList.add('opacity-0');
      moonIcon?.classList.add('opacity-0');
      systemIcon?.classList.add('opacity-0');
      
      // Show appropriate icon based on preference
      if (modePreference === 'system') {
        systemIcon?.classList.remove('opacity-0');
        systemIcon?.classList.add('opacity-100');
        if (modeText) modeText.textContent = 'SYSTEM';
      } else if (modePreference === 'dark') {
        moonIcon?.classList.remove('opacity-0');
        moonIcon?.classList.add('opacity-100');
        if (modeText) modeText.textContent = 'DARK';
      } else {
        sunIcon?.classList.remove('opacity-0');
        sunIcon?.classList.add('opacity-100');
        if (modeText) modeText.textContent = 'LIGHT';
      }
    }

    function updateActiveThemeOption(theme: string) {
      themeOptions.forEach(option => {
        const checkmark = option.querySelector('.theme-checkmark');
        if ((option as HTMLElement).dataset.theme === theme) {
          option.classList.add('!bg-main', '!text-secondary');
          checkmark?.classList.remove('opacity-0');
          checkmark?.classList.add('opacity-100');
        } else {
          option.classList.remove('!bg-main', '!text-secondary');
          checkmark?.classList.remove('opacity-100');
          checkmark?.classList.add('opacity-0');
        }
      });
    }

    function updateActiveModeOption(modePreference: string) {
      modeOptions.forEach(option => {
        const checkmark = option.querySelector('.mode-checkmark');
        if ((option as HTMLElement).dataset.mode === modePreference) {
          option.classList.add('!bg-main', '!text-secondary');
          checkmark?.classList.remove('opacity-0');
          checkmark?.classList.add('opacity-100');
        } else {
          option.classList.remove('!bg-main', '!text-secondary');
          checkmark?.classList.remove('opacity-100');
          checkmark?.classList.add('opacity-0');
        }
      });
    }

    function updateCurrentThemePreview(theme: string) {
      if (currentThemePreview) {
        currentThemePreview.className = `w-4 h-4 border border-main theme-preview-current ${theme}-preview md:flex-shrink-0`;
      }
      // Update theme name text
      if (themeNameText) {
        // Get theme name from themes data or fallback to uppercase theme key
        const themeName = getThemeName(theme);
        themeNameText.textContent = themeName;
      }
    }
    
    function getThemeName(theme: string): string {
      // Get theme name from imported themes data
      const themesModule = typeof window !== 'undefined' && (window as any).themes;
      if (themesModule && themesModule[theme]) {
        return themesModule[theme].name;
      }
      
      // Fallback theme names for current themes
      const themeNames: Record<string, string> = {
        'void': 'VOID',
        'phantom': 'PHANTOM',
        'bloom': 'BLOOM',
        'crimson': 'CRIMSON',
        'azure': 'AZURE',
        'volt': 'VOLT',
        'forest': 'FOREST',
        'ember': 'EMBER',
        'flame': 'FLAME',
        'violet': 'VIOLET',
        'plasma': 'PLASMA',
        'solar': 'SOLAR',
        'frost': 'FROST',
        'neon': 'NEON',
        'pulse': 'PULSE',
        'prism': 'PRISM'
      };
      return themeNames[theme] || theme.toUpperCase();
    }



    // Show hotkey hints on first visit
    const hasSeenHints = localStorage.getItem('nav-hints-seen');
    if (!hasSeenHints) {
      setTimeout(() => {
        const hints = document.createElement('div');
        hints.innerHTML = `
          <div style="
            position: fixed; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            background: rgba(0,0,0,0.9); 
            color: white; 
            padding: 1rem; 
            border-radius: 8px; 
            font-size: 0.875rem;
            z-index: 1000;
            backdrop-filter: blur(10px);
          ">
            💡 Tip: Use keyboard shortcuts to navigate (P, B, A, C)
            <button onclick="this.parentElement.parentElement.remove(); localStorage.setItem('nav-hints-seen', 'true')" 
                    style="margin-left: 1rem; padding: 0.25rem 0.5rem; background: transparent; border: 1px solid white; color: white; border-radius: 4px; cursor: pointer;">
              Got it
            </button>
          </div>
        `;
        document.body.appendChild(hints);
      }, 2000);
    }
  });
</script>

<style>
  /* Theme previews using CSS variables */
  .void-preview { 
    background: linear-gradient(45deg, var(--void-colorful) 50%, var(--void-contrasty) 50%); 
    border-color: var(--void-contrasty) !important;
  }
  .phantom-preview { 
    background: linear-gradient(45deg, var(--phantom-colorful) 50%, var(--phantom-contrasty) 50%); 
    border-color: var(--phantom-contrasty) !important;
  }
  .azure-preview { 
    background: linear-gradient(45deg, var(--azure-colorful) 50%, var(--azure-contrasty) 50%); 
    border-color: var(--azure-contrasty) !important;
  }
  .ember-preview { 
    background: linear-gradient(45deg, var(--ember-colorful) 50%, var(--ember-contrasty) 50%); 
    border-color: var(--ember-contrasty) !important;
  }
  .violet-preview { 
    background: linear-gradient(45deg, var(--violet-colorful) 50%, var(--violet-contrasty) 50%); 
    border-color: var(--violet-contrasty) !important;
  }
  .crimson-preview { 
    background: linear-gradient(45deg, var(--crimson-colorful) 50%, var(--crimson-contrasty) 50%); 
    border-color: var(--crimson-contrasty) !important;
  }
  .forest-preview { 
    background: linear-gradient(45deg, var(--forest-colorful) 50%, var(--forest-contrasty) 50%); 
    border-color: var(--forest-contrasty) !important;
  }

  /* Mode icon states */
  html:not(.dark) .sun-icon {
    opacity: 1;
  }

  html:not(.dark) .moon-icon {
    opacity: 0;
  }

  html.dark .sun-icon {
    opacity: 0;
  }

  html.dark .moon-icon {
    opacity: 1;
  }

  .system-icon {
    opacity: 0;
  }

 

  /* Hide hotkeys on mobile devices */
  @media (max-width: 768px) {
    /* Hide navigation hotkeys */
    .nav-link .text-xs.font-bold.font-mono {
      display: none;
    }
    
    /* Hide theme dropdown hotkeys */
    .theme-dropdown .border-t.border-main {
      display: none;
    }
  }
</style>